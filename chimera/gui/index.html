<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Chimera v4.14.26 - Unified Dashboard</title>
    <!-- Favicon: Use chimera_logo.png if available, otherwise inline SVG -->
    <link rel="icon" type="image/png" href="chimera_logo.png" onerror="this.href='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><rect fill=\"%23111\" width=\"100\" height=\"100\" rx=\"15\"/><text x=\"50\" y=\"65\" font-size=\"50\" text-anchor=\"middle\" fill=\"%2322c55e\" font-family=\"serif\">œá</text></svg>'">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background: #0a0a0c; }
        .card { background: linear-gradient(135deg, #1a1a1f 0%, #12121a 100%); border: 1px solid #2a2a35; border-radius: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.up { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-dot.down { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .live-badge { animation: live-pulse 1s infinite; }
        @keyframes live-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .trade-row { transition: all 0.2s; }
        .trade-row:hover { background: rgba(255,255,255,0.05); }
        .trade-win { border-left: 3px solid #22c55e; }
        .trade-loss { border-left: 3px solid #ef4444; }
        .metric-hero { font-size: 2.5rem; font-weight: 700; line-height: 1; }
        .scrollable { max-height: 400px; overflow-y: auto; }
        .scrollable::-webkit-scrollbar { width: 6px; }
        .scrollable::-webkit-scrollbar-track { background: #1a1a1f; }
        .scrollable::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        .symbol-gold { color: #fbbf24; }
        .symbol-nas { color: #60a5fa; }
        .symbol-us30 { color: #34d399; }
        .logo-container { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .logo-container img { width: 40px; height: 40px; border-radius: 8px; }
        .logo-fallback { width: 40px; height: 40px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #111; font-family: serif; }
    </style>
</head>
<body class="text-gray-300 min-h-screen p-4">
    <div class="max-w-[1400px] mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <!-- Logo with fallback -->
                <div class="logo-container">
                    <img id="logo-img" src="chimera_logo.png" alt="Chimera" onerror="document.getElementById('logo-img').style.display='none'; document.getElementById('logo-fallback').style.display='flex';">
                    <div id="logo-fallback" class="logo-fallback" style="display: none;">œá</div>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">CHIMERA v4.14.26</h1>
                    <span class="text-xs text-gray-500">UNIFIED ENGINE</span>
                </div>
                <span class="text-xs bg-green-600 px-2 py-1 rounded live-badge ml-2">LIVE</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                    <div id="ws-dot" class="status-dot down"></div>
                    <span id="ws-text" class="text-xs">Disconnected</span>
                </div>
                <input id="ws-url" type="text" value="ws://45.85.3.38:7777" 
                       class="bg-gray-800 text-xs px-2 py-1 rounded border border-gray-700 w-44">
                <button onclick="reconnect()" class="bg-blue-600 text-xs px-3 py-1 rounded hover:bg-blue-500">Connect</button>
                <button onclick="killSwitch()" class="bg-red-700 text-xs px-3 py-1 rounded hover:bg-red-600 font-bold">‚ö†Ô∏è KILL</button>
            </div>
        </div>

        <!-- Symbols Banner -->
        <div class="card p-3 mb-4 border border-blue-700/50 bg-blue-900/10">
            <div class="flex items-center justify-center gap-8">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ü•á</span>
                    <span class="symbol-gold font-bold text-lg">XAUUSD</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üìà</span>
                    <span class="symbol-nas font-bold text-lg">NAS100</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üìä</span>
                    <span class="symbol-us30 font-bold text-lg">US30</span>
                </div>
            </div>
        </div>

        <!-- NAS100 Settings Lock Banner -->
        <div class="card p-3 mb-4 border border-green-700/50 bg-green-900/10">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <span class="text-green-400 text-lg">üîí</span>
                    <div class="text-sm">
                        <span class="text-green-400 font-bold">NAS100 BACKTEST-LOCKED</span>
                        <span class="text-gray-400 ml-2">|</span>
                        <span class="text-gray-300 ml-2">OR: 15min</span>
                        <span class="text-gray-400 mx-2">|</span>
                        <span class="text-gray-300">Range: 25-120pts</span>
                        <span class="text-gray-400 mx-2">|</span>
                        <span class="text-gray-300">Sweep: 35pts</span>
                        <span class="text-gray-400 mx-2">|</span>
                        <span class="text-gray-300">Revert: 18pts</span>
                        <span class="text-gray-400 mx-2">|</span>
                        <span class="text-gray-300">Size: 2.0x</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-12 gap-4">
            
            <!-- Left: Session Stats -->
            <div class="col-span-4">
                <div class="card p-4">
                    <h2 class="text-sm text-gray-500 mb-3 border-b border-gray-700 pb-2">SESSION P&L</h2>
                    <div id="session-pnl" class="metric-hero text-green-400">+0.00R</div>
                    <div class="text-sm text-gray-500">$<span id="session-pnl-dollars">0.00</span></div>
                </div>

                <div class="card p-4 mt-4">
                    <h2 class="text-sm text-gray-500 mb-3 border-b border-gray-700 pb-2">TODAY</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>Trades</span><span id="total-trades" class="text-white font-bold">0</span></div>
                        <div class="flex justify-between"><span>Win Rate</span><span id="win-rate" class="text-white font-bold">0%</span></div>
                        <div class="flex justify-between"><span>Avg R</span><span id="avg-r" class="text-white font-bold">0.00</span></div>
                    </div>
                </div>
                
                <div class="card p-4 mt-4">
                    <h2 class="text-sm text-gray-500 mb-3 border-b border-gray-700 pb-2">BY SYMBOL</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="symbol-gold">XAUUSD</span><span id="xauusd-trades">0 trades</span></div>
                        <div class="flex justify-between"><span class="symbol-nas">NAS100</span><span id="nas100-trades">0 trades</span></div>
                        <div class="flex justify-between"><span class="symbol-us30">US30</span><span id="us30-trades">0 trades</span></div>
                    </div>
                </div>
            </div>

            <!-- Center: Symbol Cards + Trade Log -->
            <div class="col-span-5">
                <!-- Symbol Cards Row -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <!-- XAUUSD Card -->
                    <div class="card p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="symbol-gold font-bold">XAUUSD</span>
                            <div id="xauusd-status" class="status-dot down"></div>
                        </div>
                        <div id="xauusd-price" class="text-xl font-bold text-white">--</div>
                        <div id="xauusd-spread" class="text-xs text-gray-500">spread: --</div>
                        <div id="xauusd-regime" class="text-xs text-gray-500">regime: --</div>
                    </div>
                    
                    <!-- NAS100 Card -->
                    <div class="card p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="symbol-nas font-bold">NAS100</span>
                            <div id="nas100-status" class="status-dot down"></div>
                        </div>
                        <div id="nas100-price" class="text-xl font-bold text-white">--</div>
                        <div id="nas100-spread" class="text-xs text-gray-500">spread: --</div>
                        <div id="nas100-regime" class="text-xs text-gray-500">OR: --</div>
                    </div>
                    
                    <!-- US30 Card -->
                    <div class="card p-3">
                        <div class="flex items-center justify-between mb-2">
                            <span class="symbol-us30 font-bold">US30</span>
                            <div id="us30-status" class="status-dot down"></div>
                        </div>
                        <div id="us30-price" class="text-xl font-bold text-white">--</div>
                        <div id="us30-spread" class="text-xs text-gray-500">spread: --</div>
                        <div id="us30-regime" class="text-xs text-gray-500">OR: --</div>
                    </div>
                </div>

                <!-- Trade Log -->
                <div class="card p-4">
                    <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                        <h2 class="text-sm text-gray-500">TRADE LOG</h2>
                        <button onclick="clearTrades()" class="text-xs text-gray-500 hover:text-white">Clear</button>
                    </div>
                    <div id="trade-log" class="scrollable space-y-2">
                        <div class="text-gray-500 text-center py-8">No trades yet</div>
                    </div>
                </div>
            </div>

            <!-- Right: Status Panels -->
            <div class="col-span-3">
                <!-- Connections -->
                <div class="card p-4">
                    <h2 class="text-sm text-gray-500 mb-3 border-b border-gray-700 pb-2">CONNECTIONS</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">OpenAPI</span>
                            <div class="flex items-center gap-2">
                                <div id="openapi-dot" class="status-dot down"></div>
                                <span id="openapi-text" class="text-xs">Disconnected</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">WebSocket</span>
                            <div class="flex items-center gap-2">
                                <div id="gui-dot" class="status-dot down"></div>
                                <span id="gui-text" class="text-xs">Disconnected</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Engines -->
                <div class="card p-4 mt-4">
                    <h2 class="text-sm text-gray-500 mb-3 border-b border-gray-700 pb-2">ENGINES</h2>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between"><span>NAS100_SWEEP</span><span id="eng-nas-sweep" class="text-green-400">READY</span></div>
                        <div class="flex justify-between"><span>US30_SWEEP</span><span id="eng-us30-sweep" class="text-green-400">READY</span></div>
                        <div class="flex justify-between"><span>XAUUSD_MEAN_REVERT</span><span id="eng-xau-mr" class="text-green-400">READY</span></div>
                        <div class="flex justify-between"><span>XAUUSD_STOP_FADE</span><span id="eng-xau-sf" class="text-green-400">READY</span></div>
                        <div class="flex justify-between"><span>XAUUSD_ACCEPT_BO</span><span id="eng-xau-bo" class="text-green-400">READY</span></div>
                    </div>
                </div>

                <!-- Uptime -->
                <div class="card p-4 mt-4">
                    <h2 class="text-sm text-gray-500 mb-3 border-b border-gray-700 pb-2">UPTIME</h2>
                    <div id="uptime" class="text-2xl font-bold text-white">00:00:00</div>
                    <div id="last-tick" class="text-xs text-gray-500">Last: --</div>
                </div>

                <!-- Risk -->
                <div class="card p-4 mt-4">
                    <h2 class="text-sm text-gray-500 mb-3 border-b border-gray-700 pb-2">RISK</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>Daily Limit</span><span id="daily-limit" class="text-white">$200</span></div>
                        <div class="flex justify-between"><span>Used</span><span id="daily-used" class="text-green-400">$0.00</span></div>
                        <div class="flex justify-between"><span>Status</span><span id="risk-status" class="text-green-400">OK</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-600 text-xs mt-4">
            Chimera v4.14.26 Unified | XAUUSD + NAS100 + US30 | CRTP Architecture
        </div>
    </div>

    <script>
        let ws = null;
        let startTime = Date.now();
        let trades = [];
        let lastData = null;
        let tickCount = 0;

        function connect(url) {
            if (ws) ws.close();
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    document.getElementById('ws-dot').className = 'status-dot up';
                    document.getElementById('ws-text').textContent = 'Connected';
                    document.getElementById('gui-dot').className = 'status-dot up';
                    document.getElementById('gui-text').textContent = 'Connected';
                    console.log('[WS] Connected to', url);
                };
                
                ws.onclose = () => {
                    document.getElementById('ws-dot').className = 'status-dot down';
                    document.getElementById('ws-text').textContent = 'Disconnected';
                    document.getElementById('gui-dot').className = 'status-dot down';
                    document.getElementById('gui-text').textContent = 'Disconnected';
                    console.log('[WS] Disconnected, reconnecting in 3s...');
                    setTimeout(() => connect(url), 3000);
                };
                
                ws.onerror = (e) => {
                    document.getElementById('ws-dot').className = 'status-dot down';
                    console.error('[WS] Error:', e);
                };
                
                ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        handleMessage(data);
                    } catch (err) {
                        console.error('[WS] Parse error:', err, e.data.substring(0, 200));
                    }
                };
            } catch (err) {
                console.error('[WS] Connection error:', err);
            }
        }

        function handleMessage(data) {
            lastData = data;
            tickCount++;
            
            // DEBUG: Log first message structure
            if (tickCount === 1) {
                console.log('[DEBUG] First message structure:', Object.keys(data));
                console.log('[DEBUG] Full message:', JSON.stringify(data).substring(0, 500));
            }
            
            // Update symbols from the symbols array
            if (data.symbols && Array.isArray(data.symbols)) {
                data.symbols.forEach(sym => {
                    updateSymbol(sym);
                });
            }
            
            // Update connection status from system object
            if (data.system) {
                const connected = data.system.ctrader === true;
                document.getElementById('openapi-dot').className = 'status-dot ' + (connected ? 'up' : 'down');
                document.getElementById('openapi-text').textContent = connected ? 'Connected' : 'Disconnected';
                
                // Update uptime from server
                if (data.system.uptime_str) {
                    document.getElementById('uptime').textContent = data.system.uptime_str;
                }
            }
            
            // Update risk info
            if (data.risk) {
                const pnl = data.risk.pnl || 0;
                document.getElementById('daily-used').textContent = '$' + Math.abs(pnl).toFixed(2);
                document.getElementById('daily-used').className = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                
                // Check if approaching limit
                if (Math.abs(pnl) > 150) {
                    document.getElementById('risk-status').textContent = 'WARNING';
                    document.getElementById('risk-status').className = 'text-yellow-400';
                } else if (Math.abs(pnl) > 200) {
                    document.getElementById('risk-status').textContent = 'STOPPED';
                    document.getElementById('risk-status').className = 'text-red-400';
                } else {
                    document.getElementById('risk-status').textContent = 'OK';
                    document.getElementById('risk-status').className = 'text-green-400';
                }
            }
            
            // Handle trade events
            if (data.trade) {
                addTrade(data.trade);
            }
            
            // Update last tick time
            document.getElementById('last-tick').textContent = 'Last: ' + new Date().toLocaleTimeString();
        }

        function updateSymbol(sym) {
            if (!sym.symbol) return;
            
            const symbol = sym.symbol.toUpperCase();
            let elId = '';
            
            if (symbol === 'XAUUSD') elId = 'xauusd';
            else if (symbol === 'NAS100') elId = 'nas100';
            else if (symbol === 'US30') elId = 'us30';
            else return; // Unknown symbol
            
            const priceEl = document.getElementById(elId + '-price');
            const spreadEl = document.getElementById(elId + '-spread');
            const statusEl = document.getElementById(elId + '-status');
            
            if (priceEl && sym.mid > 0) {
                // Format based on symbol
                if (symbol === 'XAUUSD') {
                    priceEl.textContent = sym.mid.toFixed(2);
                    spreadEl.textContent = 'spread: ' + (sym.spread * 100).toFixed(1) + ' pips';
                } else {
                    priceEl.textContent = sym.mid.toFixed(1);
                    spreadEl.textContent = 'spread: ' + sym.spread.toFixed(1) + ' pts';
                }
                statusEl.className = 'status-dot up';
            }
        }

        function addTrade(trade) {
            const t = {
                symbol: trade.symbol || 'UNKNOWN',
                side: trade.side || 'BUY',
                qty: trade.qty || 0,
                price: trade.price || 0,
                pnl: trade.pnl || 0,
                engine: trade.engine || 'CFD',
                strategy: trade.strategy || 'Unknown',
                time: new Date().toLocaleTimeString()
            };
            
            trades.unshift(t);
            if (trades.length > 50) trades.pop();
            
            renderTrades();
            updateStats();
        }

        function renderTrades() {
            const log = document.getElementById('trade-log');
            
            if (trades.length === 0) {
                log.innerHTML = '<div class="text-gray-500 text-center py-8">No trades yet</div>';
                return;
            }
            
            log.innerHTML = trades.map(t => {
                const isWin = t.pnl >= 0;
                const symbolClass = t.symbol === 'XAUUSD' ? 'symbol-gold' : 
                                   t.symbol === 'NAS100' ? 'symbol-nas' : 'symbol-us30';
                return `
                    <div class="trade-row ${isWin ? 'trade-win' : 'trade-loss'} p-2 rounded text-xs">
                        <div class="flex justify-between">
                            <span class="${symbolClass}">${t.symbol}</span>
                            <span class="${isWin ? 'text-green-400' : 'text-red-400'}">${isWin ? '+' : ''}$${t.pnl.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-gray-500">
                            <span>${t.side} ${t.qty} @ ${t.price.toFixed(2)}</span>
                            <span>${t.time}</span>
                        </div>
                        <div class="text-gray-600">${t.engine} | ${t.strategy}</div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const total = trades.length;
            const wins = trades.filter(t => t.pnl >= 0).length;
            const totalPnl = trades.reduce((sum, t) => sum + t.pnl, 0);
            
            document.getElementById('total-trades').textContent = total;
            document.getElementById('win-rate').textContent = total > 0 ? (wins / total * 100).toFixed(0) + '%' : '0%';
            document.getElementById('avg-r').textContent = total > 0 ? (totalPnl / total).toFixed(2) : '0.00';
            
            // Session P&L
            const pnlEl = document.getElementById('session-pnl');
            const dollarsEl = document.getElementById('session-pnl-dollars');
            pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
            pnlEl.className = 'metric-hero ' + (totalPnl >= 0 ? 'text-green-400' : 'text-red-400');
            dollarsEl.textContent = totalPnl.toFixed(2);
            
            // Symbol counts
            document.getElementById('xauusd-trades').textContent = trades.filter(t => t.symbol === 'XAUUSD').length + ' trades';
            document.getElementById('nas100-trades').textContent = trades.filter(t => t.symbol === 'NAS100').length + ' trades';
            document.getElementById('us30-trades').textContent = trades.filter(t => t.symbol === 'US30').length + ' trades';
        }

        function reconnect() {
            const url = document.getElementById('ws-url').value;
            connect(url);
        }

        function killSwitch() {
            if (confirm('‚ö†Ô∏è KILL SWITCH: Stop all trading?')) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'kill' }));
                    console.log('[KILL] Kill command sent');
                }
            }
        }

        function clearTrades() {
            trades = [];
            renderTrades();
            updateStats();
        }

        function updateLocalUptime() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const mins = Math.floor((elapsed % 3600) / 60);
            const secs = elapsed % 60;
            // Only update if server uptime not available
            if (!lastData || !lastData.system || !lastData.system.uptime_str) {
                document.getElementById('uptime').textContent = 
                    String(hours).padStart(2, '0') + ':' + 
                    String(mins).padStart(2, '0') + ':' + 
                    String(secs).padStart(2, '0');
            }
        }

        // Initialize
        setInterval(updateLocalUptime, 1000);
        reconnect();
        
        console.log('[Chimera] Dashboard v4.14.26 initialized');
        console.log('[Chimera] Expecting JSON: {symbols: [...], system: {ctrader: bool}, risk: {...}}');
    </script>
</body>
</html>
